
# CPU 模式

## 正常模式 10000
### usr
正常模式下只能保持在正常模式，无法通过软件切换跳转到异常模式。

## 特权模式
特权模式下可以任意转换为另一种模式，且出sys模式外，不同模式下会有专属寄存器。且均有专用的sp lr寄存器
### sys 系统模式 11111

### irq 中断模式 10010
1. 软件中断
    * 使用 swi # 指令
### und 未定义模式 11011
遇到未定义的指令

### fiq 快速中断模式 10001

### svc 管理模式 10011

### abt 终止模式 10111
1. 指令读取终止
1. 数据读取终止
## 特殊寄存器
### r13_xxx

### r14_xxx

### CPSR
* CPSR[4:0]=工作模式
* CPSR[5]=指令模式
* CPSR[6]=FIQ 开关
* CPSR[6]=IRQ 开关
* CPSR[31:28]=运算结果（小于、零、？、溢出）
### SRSR_xxx
用来保存被中断模式的CPSR


# 中断程序

## 中断向量表 手册p82


# 异常处理流程
### 进入异常 (硬件完成)
1. 将下一条指令的地址（PC+4 OR PC+8 ）保存到lr寄存器（异常专属）中 
2. 将CPSR 复制到SPSR
3. 根据异常设置CPSR的模式位
4. 使PC跳转到异常向量表
   
### 退出异常 软件完成
1. 将lr寄存器（异常专属）的地址减去一个偏移后赋值给PC（偏移大小取决于模式）
2. 将SPSR恢复到CRSR
3. 清除设置的标志位

### 异常处理
0. 初始化
    * 设置异常模式的堆栈
1. 保存现场
    * 保存寄存器（r0~r12,lr） 
2. 处理异常
   
3. 恢复现场
    * 恢复寄存器


# 中断处理流程
## 初始化
1. 设置CPSR开启中断
2. 设置引脚为中断模式
3. 设置引脚中断触发方式
4. 设置外部中断屏蔽 手册306
## 处理中断
### 外部中断
1. 读取INTOFFSET 分辨中断源
2. 读取EINTPEND 分辨中断引脚
## 清中断
清理中断标志位时从源头开始，通过在目标位写入 1 来清除！

EINTPEND -> SRCPND -> INTPND